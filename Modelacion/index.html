<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        html, body
        {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
            overflow: hidden;
        }
      </style>
</head>
<body>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.7/dat.gui.min.js"></script>
    <script type="module">
        import * as THREE from 'https://unpkg.com/three/build/three.module.js';
        import Stats from "https://unpkg.com/three/examples/jsm/libs/stats.module.js";
        import {OrbitControls} from "https://unpkg.com/three@0.119.0/examples/jsm/controls/OrbitControls.js";
        import {OBJLoader} from 'https://cdn.jsdelivr.net/npm/three@0.117.1/examples/jsm/loaders/OBJLoader.js';

        "use strict";

        let renderer, scene, camera, orbitControls, model, stats, gui;
        
        function init(event) {
            // RENDERER ENGINE
            renderer = new THREE.WebGLRenderer({antialias: true});
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setViewport(0, 0, window.innerWidth, window.innerHeight);
            renderer.setClearColor(new THREE.Color(0, 0, 0));
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);
            
            // SCENE
            scene = new THREE.Scene();

            // MODELS
            const scenary = new Scenary();
            model = new CalseCar(0,200);
            const traffic = new BaseTrafficLight();

            // SCENE GRAPH
            scene.add(scenary);
            scene.add(model);
            scene.add(traffic);
            //scene.add(lane);

            // CAMERA (PERSPECTIVE)
            const fov = 60;    // Field ov view
            const aspect = window.innerWidth / window.innerHeight;
            const near = 0.01;
            const far = 10000.0;
            camera = new THREE.PerspectiveCamera(fov, aspect, near, far);
            camera.position.set(-100, 100, 300);
            // CAMERA CONTROLS
            orbitControls = new OrbitControls(camera, renderer.domElement);
            //orbitControls.target = model.position;
            orbitControls.update();

            // SETUP STATS
            stats = new Stats();
            stats.showPanel(0); // 0: fps, 1: ms, 2: mb, 3+: custom
            document.body.appendChild(stats.dom);

            // GUI
            gui = new dat.GUI();

            // SCENE-MENU
            const guiSceneMenu = gui.addFolder("Scene Menu");
            guiSceneMenu.add(scenary.axes, "visible").setValue(scenary.axes.visible).name("World Axes").listen().onChange(function(value) {
                scenary.axes.setVisible(value);
            });

            guiSceneMenu.add(scenary.floor, "visible").setValue(scenary.floor.visible).name("Floor").listen().onChange(function(value) {
                scenary.floor.setVisible(value);
            });

            guiSceneMenu.open();

            // MODEL-MENU
            const guiModelMenu = gui.addFolder("Model Menu");
            // GUI-Model
            guiModelMenu.add(model, "visible").setValue(true).name("Show").listen().onChange(function(value) {});

            // WIREFRAME: Mostrar modelo como sólido o wireframe
            guiModelMenu.add(model, "material").setValue(model.material).name("Wireframe").listen().onChange(function(value) {
                model.setWireframe(value);
            });

            // COLOR: colorear el modelo 
            // Car bottom
            guiModelMenu.addColor(model, 'carBottomColor').setValue(model.carBottomColor).name('Color bottom').listen().onChange(function(value) {
                model.setCarBottomColor(value);
            });

            // Car top
            guiModelMenu.addColor(model, 'carTopColor').setValue(model.carTopColor).name('Color top').listen().onChange(function(value) {
                model.setCarTopColor(value);
            });

            // Windows
            guiModelMenu.addColor(model, 'windowsColor').setValue(model.windowsColor).name('Color windows').listen().onChange(function(value) {
                model.setWindowsColor(value);
            });

            // Tires
            guiModelMenu.addColor(model, 'tiresColor').setValue(model.tiresColor).name('Color tires').listen().onChange(function(value) {
                model.setTiresColor(value);
            });
            
            // ESCALAMIENTO: escalar el modelo (slider)
            guiModelMenu.add(model, "scaleFactor").min(4).max(8).step(0.1).setValue(model.scaleFactor).name("Scale").listen().onChange(function(value) {
                model.setScale(value);
            });

            // GUI MENU
            gui.add(model, "animate").setValue(model.rotate).name("Animate").listen().onChange(function(value) {});

            // DRAW SCENE IN A RENDER LOOP (ANIMATION)
            renderLoop();
        }

        function renderLoop() {
            stats.begin();
            renderer.render(scene, camera); // DRAW THE SCENE GRAPH
            updateScene();
            stats.end();
            requestAnimationFrame(renderLoop);
        }

        function updateScene() {
           if(model && model.animate) {
               model.position.z = model.position.z - 0.1;
           }
        }

        // EVENT LISTENERS & HANDLERS
        document.addEventListener("DOMContentLoaded", init);

        window.addEventListener("resize", () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);            
        }, false);


        class Axes extends THREE.AxesHelper {
            constructor(size = 10, visible = true) {
                super(size);
                this.size = size;
                this.visible = visible;
                this.position.set(0, 1, 0);
            }
            setVisible(value) {
                this.visible = value;
            }
        }

        class Floor extends THREE.Group {
            constructor(size = 100) {
                super();
                this.size = size;
                const geometry = new THREE.PlaneGeometry(size, size);
                const material = new THREE.MeshBasicMaterial({color: 0x505050});
                this.mesh = new THREE.Mesh(geometry, material);
                this.mesh.rotation.x = -Math.PI / 2;
                this.gridHelper = new THREE.GridHelper(size, 10, 0xff0000, 0x000000);
                // CHILDREN
                this.add(this.mesh);
                this.add(this.gridHelper);
            }
            setVisible(value = true) {
                this.visible = value;
            }
            setWireframe(value = true) {
                this.material.wireframe = value;
            }
            setColor(color) {
                this.mesh.material.color.setHex(color);
            }
        }

        class BaseTrafficLight extends THREE.Mesh {
            constructor(height = 5) {
                const geometry = new THREE.CylinderGeometry( 0.15, 0.15, height, 32 ); // radius top, radius bottom, height, segments
                const material = new THREE.MeshBasicMaterial( {color: 0x94B3FD} );
                const cylinder = new THREE.Mesh( geometry, material );
                super(geometry, material);
                this.color = 0x94B3FD;
                this.setOnFloor();
            }
        
            getColor() {
                return this.color;
            }

            setColor(hexColor) {
                this.material.color.setHex(hexColor);
            }

            setOnFloor() {
                this.geometry.computeBoundingBox();
                const bBox = this.geometry.boundingBox;
                this.position.y = -bBox.min.y;
            }
        }

        class Sphere extends THREE.Group {
            constructor(x = 0, y = 0, z = 0, radius = 0.2, color = 0xcc0000, wireColor = 0xffffff) {
                super();
                this.radius = radius;
                this.color = color;
                this.wireColor = wireColor;
                this.doubleSide = false;
                this.rotate = false;
                this.position.set(x, y, z);
                // Geometría
                const geometry = new THREE.SphereGeometry(radius, 32, 16);

                // Material
                const material = new THREE.MeshBasicMaterial({color});
                const materialWire = new THREE.MeshBasicMaterial({wireframe: true, color: wireColor});

                // Low resolution
                this.solid = new THREE.Mesh(geometry, material);
                this.wire = new THREE.Mesh(geometry, materialWire);

                this.add(this.solid);
                this.add(this.wire);
            }
            setWireframe(value = true) {
                this.solid.setVisible(value);
            }
            setColor(hexColor) {
                this.color = hexColor;
                this.solid.material.color.setHex(hexColor);
            }
            setWireColor(hexColor) {
                this.wireColor = hexColor;
                this.wire.material.color.setHex(hexColor);
            }
            setDoubleSide(value) {
                this.doubleSide = value;
                if(value) {
                    this.solid.material.side = THREE.DoubleSide;
                } else {
                    this.solid.material.side = THREE.FrontSide;
                }
            }
            setOnFloor() {
                this.medium.solid.geometry.computeBoundingBox();
                const bBox = this.medium.solid.geometry.boundingBox;
                this.position.y = -bBox.min.y;
            }
        }



        // COMPONENTES DE AUTO
        // Uso de Buffer Geometry
        class TriangularPrism extends THREE.Mesh {
            constructor() {
                super();
                const vertices = new Float32Array([
                    0.2, 0, 0,
                    -0.2, 0, 0,
                    -0.2, 0, 0.5,

                    0.2, 1, 0,
                    -0.2, 1, 0,
                    -0.2, 1, 0.5,
                ]);

                const indices = [
                    0, 1, 2, // Top
                    5, 4, 3, // Bottom
                    3, 1, 0, // Back
                    1, 3, 4, // Back
                    0, 2, 3, // Left
                    5, 3, 2, // Left
                    4, 2, 1, // Right
                    2, 4, 5, // Right
                ];


                this.geometry = new THREE.BufferGeometry();
                this.geometry.setAttribute('position', new THREE.BufferAttribute(vertices, 3));
                this.geometry.setIndex(indices);
                this.material = new THREE.MeshBasicMaterial({color: 0x00008b});
                this.rotation.x = -Math.PI/2;   
            }
            setColor(hexColor) {
                this.material.color.setHex(hexColor);
            }
        }

        class Tire extends THREE.Mesh {
            constructor() {
                const geometry = new THREE.CylinderGeometry( 0.2, 0.2, 1.2, 32 ); // radius top, radius bottom, height, segments
                const material = new THREE.MeshBasicMaterial( {color: 0x5a5a5a} );
                const cylinder = new THREE.Mesh( geometry, material );
                super(geometry, material);
                this.rotation.x = Math.PI/2;    
                this.color = 0x5a5a5a;
            }
        
            getColor() {
                return this.color;
            }

            setColor(hexColor) {
                this.material.color.setHex(hexColor);
            }
        }

        class SideWindow extends THREE.Mesh {
            constructor() {
                const geometry = new THREE.BoxBufferGeometry(1, 0.3, 1.1); // width, height, depth
                const material = new THREE.MeshBasicMaterial( {color: 0xdce9f5} );
                super(geometry, material);
                this.color = 0xdce9f5;
            }
            getColor() {
                return this.color;
            }

            setColor(hexColor) {
                this.material.color.setHex(hexColor);
            }
        }

        class FrontWindow extends THREE.Mesh {
            constructor() {
                const geometry = new THREE.BoxBufferGeometry(0.1, 0.3, .8);
                const material = new THREE.MeshBasicMaterial( {color: 0xdce9f5} );
                super(geometry, material);
            }
            setColor(hexColor) {
                this.material.color.setHex(hexColor);
            }
        }

        class CarBottom extends THREE.Mesh {
            constructor() {
                const geometry = new THREE.BoxBufferGeometry(2, 0.5, 1);
                const material = new THREE.MeshBasicMaterial( {color: 0x00008b} ); //00008b
                super(geometry, material);
                this.color = 0x00008b;
            }
            getColor() {
                return this.color;
            }

            setColor(hexColor) {
                this.material.color.setHex(hexColor);
            }
        }

        class CarTop extends THREE.Mesh {
            constructor() {
                const geometry = new THREE.BoxBufferGeometry(1.2, 0.4, 1);
                const material = new THREE.MeshBasicMaterial( {color: 0xf1f1f1} );
                super(geometry, material);
                this.color = 0xf1f1f1;
            }
            getColor() {
                return this.color;
            }

            setColor(hexColor) {
                this.material.color.setHex(hexColor);
            }
        }

        // CLASE AUTO, AGRUPA COMPONENTES 
        // Uso de THREE.Group
        class CalseCar extends THREE.Group {
            constructor(x = 0, z = 0) {
                super();
                this.x = x;
                this.z = z;
                this.material = false;
                this.scaleFactor = 5;
                this.rotate = true;

                // Llantas traseras
                this.rearTires = new Tire();
                this.rearTires.position.y = 0.1;
                this.rearTires.position.x = -0.6;
                this.tiresColor = this.rearTires.getColor();

                // Llantas frontales
                this.frontTires = new Tire();
                this.frontTires.position.y = 0.1;
                this.frontTires.position.x = 0.6;

                // Parte de abajo
                this.carBottom = new CarBottom();
                this.carBottom.position.y = 0.3;
                this.carBottom.position.x = 0;
                this.carBottomColor = this.carBottom.getColor();

                // Parte enfrente
                this.frontPart = new TriangularPrism();
                this.frontPart.position.y = 0.05;
                this.frontPart.position.x = 1.2;
                this.frontPart.position.z = 0.5;

                // Parte de arriba
                this.carTop = new CarTop();
                this.carTop.position.y = 0.75;
                this.carTop.position.x = -0.1;
                this.carTopColor = this.carTop.getColor();

                // Ventanas de lados
                this.sideWindow = new SideWindow();
                this.sideWindow.position.y = 0.75;
                this.sideWindow.position.x = -0.1;
                this.windowsColor = this.sideWindow.getColor();

                // Ventana frontal
                this.frontWindow = new FrontWindow();
                this.frontWindow.position.y = 0.75;
                this.frontWindow.position.x = .5;

                this.add(this.rearTires);
                this.add(this.frontTires);
                this.add(this.carBottom);
                this.add(this.frontPart);
                this.add(this.carTop);
                this.add(this.sideWindow);
                this.add(this.frontWindow);

                this.setScale(this.scaleFactor);
                this.rotation.y = Math.PI /2;
                this.animate = false;
                this.position.set(x, 0, z);
            }

            // WIREFRAME
            setWireframe(value) {
                this.rearTires.material.wireframe = value;
                this.frontTires.material.wireframe = value;
                this.carBottom.material.wireframe = value;
                this.frontPart.material.wireframe = value;
                this.carTop.material.wireframe = value;
                this.sideWindow.material.wireframe = value;
                this.frontWindow.material.wireframe = value;
            }

            // COLOR
            setCarBottomColor(hexColor) {
                this.color = hexColor;
                this.carBottom.setColor(this.color);
                this.frontPart.setColor(this.color);
            }
            
            setCarTopColor(hexColor) {
                this.carTop.setColor(hexColor);
            }
            
            setWindowsColor(hexColor) {
                this.sideWindow.setColor(hexColor);
                this.frontWindow.setColor(hexColor);
            }
            
            setTiresColor(hexColor) {
                this.rearTires.setColor(hexColor);
                this.frontTires.setColor(hexColor);
            }

            // ESCALAR
            setScale(value) {
                this.scale.set(value, value, value);
            }

            // ROTAR
            updateRotation(value) {
                this.rotate = value;
                renderLoop();
            }
        }

        class Lane extends THREE.Group {
            constructor(x = 0, z = 0, front = 200, depth = 1,height = 0.3,color =0xffff00 ) {
                super();
                this.front = front;
                this.length = length;
                this.height = height;
                this.position.set(x, 0, z);
                this.color = color;
                this.wireColor = 0xffffff;
                this.doubleSide = false;
                this.rotate = false;
                const geometry = new THREE.BoxGeometry(this.front, this.height, this.depth);
                const material = new THREE.MeshBasicMaterial({color: this.color});
                const materialWire = new THREE.MeshBasicMaterial({wireframe: true, color: this.wireColor});
                this.solid = new THREE.Mesh(geometry, material);
                this.wire = new THREE.Mesh(geometry, materialWire);
                // CHILDREN
                this.setOnFloor();
                this.add(this.solid);
                this.add(this.wire);
            }
            setWireframe(value = true) {
                this.solid.setVisible(value);
            }
            setColor(hexColor) {
                this.color = hexColor;
                this.solid.material.color.setHex(hexColor);
            }
            setWireColor(hexColor) {
                this.wireColor = hexColor;
                this.wire.material.color.setHex(hexColor);
            }
            setOnFloor() {
                this.solid.geometry.computeBoundingBox();
                const bBox = this.solid.geometry.boundingBox;
                this.position.y = -bBox.min.y;
            }
        }

        class Building extends THREE.Group {
            constructor(x = 0, z = 0, front = 50, depth = 50, height = 10, color = 0xcc0000, wireColor = 0xffffff) {
                super();
                this.front = front;
                this.length = length;
                this.height = height;
                this.position.set(x, 0, z);
                this.color = color;
                this.wireColor = wireColor;
                this.doubleSide = false;
                this.rotate = false;
                const geometry = new THREE.BoxGeometry(front, height, depth);
                const material = new THREE.MeshBasicMaterial({color});
                const materialWire = new THREE.MeshBasicMaterial({wireframe: true, color: wireColor});
                this.solid = new THREE.Mesh(geometry, material);
                this.wire = new THREE.Mesh(geometry, materialWire);
                this.setOnFloor();
                // CHILDREN
                this.add(this.solid);
                this.add(this.wire);
            }
            setWireframe(value = true) {
                this.solid.setVisible(value);
            }
            setColor(hexColor) {
                this.color = hexColor;
                this.solid.material.color.setHex(hexColor);
            }
            setWireColor(hexColor) {
                this.wireColor = hexColor;
                this.wire.material.color.setHex(hexColor);
            }
            setDoubleSide(value) {
                this.doubleSide = value;
                if(value) {
                    this.solid.material.side = THREE.DoubleSide;
                } else {
                    this.solid.material.side = THREE.FrontSide;
                }
            }
            setOnFloor() {
                this.solid.geometry.computeBoundingBox();
                const bBox = this.solid.geometry.boundingBox;
                this.position.y = -bBox.min.y;
            }
        }

        class Scenary extends THREE.Group {
            constructor(size = 1000) {
                super();
                this.axes = new Axes(size);
                this.floor = new Floor(size);
                this.buildings = [];

                 //SW - TEC - SORIANA
                 this.buildings.push(new Building(-38, 33, 50, 40, 10, 0x5AA897)); // Gasolinera-seven
                 this.buildings.push(new Building(-38, 65, 50, 20, 7));// Tires
                 this.buildings.push(new Building(-38, 102, 50, 50, 6, 0xB983FF));// Peak a bo
                 this.buildings.push(new Building(-38, 214, 50, 170, 15, 0x325288));// Tec

                 this.buildings.push(new Building(-132.5, 50.5, 135, 75, 20, 0xFFC93C));// Soriana
                 this.buildings.push(new Building(-232, 50.5, 60, 75, 10,0xF4EEE8));// Paper

                //NW - RECINTO
                this.buildings.push(new Building(-113, -161, 200, 296, 10, 0x9FE6A0));// recinto

                //SE - ESQUINA SQUARE MARKET
                this.buildings.push(new Building(38, 73, 55, 120, 25,0xFF414D)); // Square
                this.buildings.push(new Building(38, 160, 55, 50, 35, 0x1AA6B7)); // Edificio en construccion 1
                this.buildings.push(new Building(38, 209.5, 55, 45, 30, 0xEDC988)); // Edificio en construccion 2
                this.buildings.push(new Building(38, 256.5, 55, 45, 6, 0x214252)); // Cochera

                this.buildings.push(new Building(87.5, 48, 35, 70, 5, 0x693C72)); // Guarderia
                this.buildings.push(new Building(119.5, 48, 25, 70, 10, 0xDE8971)); // Edificio en construccion 3
                this.buildings.push(new Building(154, 48, 40, 70, 15, 0xD1CEBD)); // Plaza
                this.buildings.push(new Building(186, 48, 20, 70, 7, 0xA0937D)); // Altamira
                
                // NE - WALMART
                this.buildings.push(new Building(33, -38, 40, 50, 10, 0xF55C47)); // Gasolinera
                this.buildings.push(new Building(105, -125, 184, 120, 20, 0xA7D0CD)); // Walmart
                this.buildings.push(new Building(48, -247, 70, 120, 10, 0x4AA96C)); // Valle real

                this.buildings.push(new Building(75, -38, 40, 50, 7, 0xFFC93C)); // Restaurant
                this.buildings.push(new Building(147, -39, 100, 52, 20, 0xA7D0CD)); // Walmart aviacion

                //sconst lane = new Lane();
                this.add(new Lane(113, 0, 200, 1));
                this.add(new Lane(-113, 0, 200, 1));

                let lane = new Lane(0, 163, 300, 1);
                lane.rotation.y = Math.PI/2;
                this.add(lane);

                lane = new Lane(0, -163, 300, 1);
                lane.rotation.y = Math.PI/2;
                this.add(lane);

                this.add(new Sphere(0, 5, 0));
                this.add(new Sphere(0, 5, 1));

                //this.buildings.push(new Building(-113, 11.5, 100, 3, .3, 0xA7D0CD)); // Walmart aviacion
                //this.buildings.push(new Building(113, 11.5, 100, 3, .3, 0xA7D0CD)); // Walmart aviacion



                //this.add(new Lane(0, -113, 1, 200));

                // CHILDREN
                this.add(this.axes);
                this.add(this.floor);
                for(let i = 0; i < this.buildings.length; i++) {
                    this.add(this.buildings[i]);
                }
            }
        }
    </script>
</body>
</html>