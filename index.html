<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        html, body
        {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
            overflow: hidden;
        }
      </style>
      
</head>
<body>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.7/dat.gui.min.js"></script>
    
    <script type="module">
        import * as THREE from 'https://unpkg.com/three/build/three.module.js';
        import Stats from "https://unpkg.com/three/examples/jsm/libs/stats.module.js";
        import {OrbitControls} from "https://unpkg.com/three@0.119.0/examples/jsm/controls/OrbitControls.js";
        import {OBJLoader} from 'https://cdn.jsdelivr.net/npm/three@0.117.1/examples/jsm/loaders/OBJLoader.js';
        import Axes from './axes.js';
        import Floor from './floor.js';
        import Scenary from './scenery.js';
        import ClaseCar from './car.js';

        let renderer, scene, camera, orbitControls, model, stats, gui;
        
        function init(event) {
            // RENDERER ENGINE
            renderer = new THREE.WebGLRenderer({antialias: true});
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setViewport(0, 0, window.innerWidth, window.innerHeight);
            renderer.setClearColor(new THREE.Color(0, 0, 0));
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);
            
            // SCENE
            scene = new THREE.Scene();

            // MODELS
            const scenary = new Scenary();
            model = new ClaseCar(0,200);

            // SCENE GRAPH
            scene.add(scenary);
            scene.add(model);

            // CAMERA (PERSPECTIVE)
            camera = new Camera();
            camera.setPerspectiveView();
            //camera.setCrossView();


            // SETUP STATS
            stats = new Stats();
            stats.showPanel(0); // 0: fps, 1: ms, 2: mb, 3+: custom
            document.body.appendChild(stats.dom);

            // GUI
            gui = new dat.GUI();

            // SCENE-MENU
            const guiSceneMenu = gui.addFolder("Scene Menu");
            /*guiSceneMenu.add(scenary.axes, "visible").setValue(scenary.axes.visible).name("World Axes").listen().onChange(function(value) {
                scenary.axes.setVisible(value);
            });

            guiSceneMenu.add(scenary.floor, "visible").setValue(scenary.floor.visible).name("Floor").listen().onChange(function(value) {
                scenary.floor.setVisible(value);
            });*/


            
            guiSceneMenu.open();

            // MODEL-MENU
            const guiModelMenu = gui.addFolder("Model Menu");

            // GUI MENU
            gui.add(model, "animate").setValue(model.rotate).name("Animate").listen().onChange(function(value) {});



            // MENU CAMARA
            const guiCameraMenu = gui.addFolder("CameraMenu");
            // Opcion de vistas
            var opView = { Vistas: 'Perspectiva'}
            guiCameraMenu.add(opView, 'Vistas', ['Perspectiva', 'Superior', 'Cruce', 'Interior Auto']).onChange(updateView);
            // Rotacion de la camara
            guiCameraMenu.add(camera.orbitControls, "autoRotate").setValue(camera.orbitControls.autoRotate).name("Auto rotate").listen().onChange(function(value) {
                camera.setAutoRotate(value);
            });
            // Inicializar vista a perspectiva
            guiCameraMenu.add(camera, "reset").name("Reset");

            guiCameraMenu.open();

            // DRAW SCENE IN A RENDER LOOP (ANIMATION)
            renderLoop();
        }

        function renderLoop() {
            stats.begin();
            renderer.render(scene, camera); // DRAW THE SCENE GRAPH
            updateScene();
            stats.end();
            requestAnimationFrame(renderLoop);
        }

        // ACTUALIZAR VISTAS
        function updateView() {
            const value = gui.__folders.CameraMenu.__controllers[0].object.Vistas;
            switch(value) {
                case 'Perspectiva': // Vista en Perspectiva
                    camera.setPerspectiveView();
                    break;
                case 'Superior': // Vista superior  
                    camera.setTopView();
                    break; 
                case 'Cruce': // Vista superior  
                    camera.setCrossView();
                    break; 
                case 'Interior Auto': // Vista desde el interior del auto  
                    camera.setInModelView(model); 
                    break;
                default:
                    break;
            }
        }

        function updateScene() {
           if(model && model.animate) {
               model.position.z = model.position.z - 0.1;
           }

           if (camera.orbitControls.autoRotate) {
                camera.orbitControls.update();
            }

            if (camera.insideCar) {
                camera.position.z = model.position.z - 0.2;
            }
        }

        // EVENT LISTENERS & HANDLERS
        document.addEventListener("DOMContentLoaded", init);

        window.addEventListener("resize", () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);            
        }, false);      


        // CAMARA
        class Camera extends THREE.PerspectiveCamera {
            constructor(fov = 60, aspect = window.innerWidth/window.innerHeight, near = 0.1, far = 1000) {
                super(fov, aspect, near, far);
                this.insideCar = false;
                this.orbitControls = new OrbitControls(this,renderer.domElement);
                this.orbitControls.update();
                this.position.set(-80, 100, 300);
            }
            setPerspectiveView() {
                this.insideCar = false;
                this.position.set(-200, 250, 250);
                this.orbitControls.target = new THREE.Vector3(0, 0, 0);
                this.up.set(0, 1, 0)
                this.orbitControls.update();
            }

            setTopView() {
                this.insideCar = false;
                this.position.set(0, 350, 0);
                this.orbitControls.target = new THREE.Vector3(0, 0, 0);
                this.up.set(-1, 0, 0)
                this.orbitControls.update();
            }

            setCrossView() {
                this.insideCar = false;
                this.position.set(0, 70, 0);
                this.orbitControls.target = new THREE.Vector3(0, 0, 0);
                this.up.set(-1, 0, 0)
                this.orbitControls.update();
            }

            setInModelView(model) {
                this.insideCar = true;
                this.position.set(model.position.x, 4.5, model.position.z);
                this.orbitControls.target = new THREE.Vector3(0, 0, -400);
                this.up.set(0, 1, 0)
                this.orbitControls.update();
            }

            setAutoRotate(value = false) {
                this.orbitControls.autoRotate = value;
            }

            reset() {
                this.insideCar = false;
                this.setPerspectiveView();
                this.setAutoRotate();
            }

        }

    </script>
</body>
</html>